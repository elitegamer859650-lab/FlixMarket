<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Flix Market</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6C63FF; --secondary: #FF6584; }
        body { background-color: #F8FAFC; font-family: 'Segoe UI', sans-serif; }
        .profile-header { background: linear-gradient(135deg, var(--primary), #8A84FF); height: 160px; border-radius: 0 0 40px 40px; }
        .avatar-container { position: relative; width: 120px; height: 120px; margin-top: -60px; }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; border: 5px solid white; object-fit: cover; background: #eee; }
        .camera-icon { position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; cursor: pointer; }
        .save-btn { background: var(--primary); color: white; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; transition: 0.3s; }
        .save-btn:active { transform: scale(0.95); }
        .shortcut-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; gap: 20px; z-index: 1000; border: 1px solid rgba(108, 99, 255, 0.2); }
    </style>
</head>
<body class="pb-24">

    <div class="profile-header"></div>

    <div class="container mx-auto px-4 flex flex-col items-center">
        <div class="avatar-container shadow-xl">
            <img id="profileDisplay" src="https://via.placeholder.com/150" class="avatar-img">
            <label for="picInput" class="camera-icon"><i class="fas fa-camera"></i></label>
            <input type="file" id="picInput" accept="image/*" class="hidden">
        </div>

        <div class="text-center mt-4">
            <h2 id="topName" class="text-2xl font-black text-gray-800">User Name</h2>
            <p id="topEmail" class="text-gray-400 text-sm italic"></p>
        </div>

        <div class="w-full max-w-md bg-white mt-8 p-6 rounded-3xl shadow-sm space-y-5">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Display Name</label>
                <input type="text" id="editName" class="w-full p-4 mt-1 bg-gray-50 border-none rounded-xl outline-none focus:ring-2 ring-indigo-100" placeholder="Enter your name">
            </div>

            <div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">Bio / About</label>
                <textarea id="editBio" class="w-full p-4 mt-1 bg-gray-50 border-none rounded-xl outline-none focus:ring-2 ring-indigo-100 h-24 resize-none" placeholder="Tell buyers about yourself..."></textarea>
            </div>

            <button id="updateProfileBtn" class="save-btn shadow-lg shadow-indigo-100">
                <i class="fas fa-save mr-2"></i> Save Changes
            </button>
        </div>

        <button id="logoutBtn" class="mt-6 text-red-400 font-bold text-sm"><i class="fas fa-sign-out-alt mr-1"></i> Logout Account</button>
    </div>

    <div class="shortcut-bar">
        <a href="index.html" class="text-gray-300 text-xl"><i class="fas fa-home"></i></a>
        <a href="categories.html" class="text-gray-300 text-xl"><i class="fas fa-th-large"></i></a>
        <a href="add-post.html" class="text-gray-300 text-xl"><i class="fas fa-plus-circle"></i></a>
        <a href="profile.html" class="text-[#6C63FF] text-xl"><i class="fas fa-user"></i></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBMK252DCWEfxmancNHZ5kqdoNTRgbok7A", 
            databaseURL: "https://flix-market-default-rtdb.firebaseio.com", 
            projectId: "flix-market" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userPicUrl = "";

        // Load Data [cite: 2026-01-18]
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'auth.html';
            else {
                document.getElementById('topEmail').innerText = user.email;
                document.getElementById('editName').value = user.displayName || "";
                document.getElementById('topName').innerText = user.displayName || "Set Name";
                if(user.photoURL) document.getElementById('profileDisplay').src = user.photoURL;

                // Load Bio from Database [cite: 2026-01-18]
                onValue(ref(db, `users/${user.uid}/bio`), (snap) => {
                    if(snap.exists()) document.getElementById('editBio').value = snap.val();
                });
            }
        });

        // ðŸ“¸ Profile Pic Direct Upload [cite: 2026-01-17, 2026-01-18]
        document.getElementById('picInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'ed6adf2f-027f-4a5a-a6dd-39438c909da7');

            try {
                const res = await fetch('https://api.cloudinary.com/v1_1/drwhtmufj/image/upload', { method: 'POST', body: formData });
                const data = await res.json();
                userPicUrl = data.secure_url;
                document.getElementById('profileDisplay').src = userPicUrl;
                alert("Photo uploaded! Click 'Save Changes' to confirm.");
            } catch(err) { alert("Upload failed!"); }
        };

        // ðŸ’¾ Save All Changes [cite: 2026-01-18]
        document.getElementById('updateProfileBtn').onclick = async () => {
            const newName = document.getElementById('editName').value;
            const newBio = document.getElementById('editBio').value;
            const btn = document.getElementById('updateProfileBtn');

            btn.innerText = "Updating...";
            btn.disabled = true;

            try {
                // Update Auth Profile [cite: 2026-01-18]
                await updateProfile(auth.currentUser, {
                    displayName: newName,
                    photoURL: userPicUrl || auth.currentUser.photoURL
                });

                // Save Bio to Database [cite: 2026-01-18]
                await set(ref(db, `users/${auth.currentUser.uid}/bio`), newBio);

                alert("Profile Updated Successfully!");
                location.reload();
            } catch (err) {
                alert(err.message);
                btn.innerText = "Save Changes";
                btn.disabled = false;
            }
        };

        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => location.href='index.html');
    </script>
</body>
</html>
